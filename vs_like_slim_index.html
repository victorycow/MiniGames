<!doctype html><html lang="ko"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/><title>VS-like | Classic (Slim)</title><style>html,body{margin:0;height:100%;background:#0b0f14;color:#e8eefc;font:14px/1.4 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}#wrap{position:relative;width:100%;height:100%}canvas{position:absolute;inset:0;width:100%;height:100%}.hud{position:absolute;inset:0;pointer-events:none}.top{position:absolute;left:8px;right:8px;top:8px;display:grid;grid-template-columns:1fr auto auto auto auto;gap:8px;align-items:center}.chip{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:10px}.hp{height:12px;border-radius:8px;background:rgba(255,255,255,.08);overflow:hidden}.hp>div{height:100%;background:linear-gradient(90deg,#ff6b6b,#ff9aa2)}.xp{position:absolute;left:8px;right:8px;bottom:8px;height:10px;border-radius:8px;background:rgba(255,255,255,.08);overflow:hidden}.xp>div{height:100%;background:linear-gradient(90deg,#7aa2ff,#a78bfa)}.bossw{position:absolute;left:8px;right:8px;top:44px;display:none}.boss{height:12px;border-radius:8px;background:rgba(255,255,255,.08);overflow:hidden}.boss>div{height:100%;background:linear-gradient(90deg,#ff6b6b,#ffa14d)}.help{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);opacity:.8;text-align:center;pointer-events:none}kbd{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px}.pause{position:absolute;right:8px;top:8px;opacity:.8;display:none}.badge{position:absolute;left:50%;top:70px;transform:translateX(-50%);padding:4px 8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:8px;opacity:0;transition:opacity .25s;font-weight:800}.badge.show{opacity:1}.menu{position:absolute;inset:0;display:grid;place-items:center;background:rgba(10,14,20,.6);backdrop-filter:blur(3px)}.panel{width:min(900px,95vw);background:rgba(20,24,32,.92);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px}.row{display:flex;flex-wrap:wrap;gap:8px;margin:.5rem 0;align-items:center}.modal{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4)}.modal.show{display:grid}.card{width:min(820px,92vw);background:rgba(20,24,32,.92);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:8px}.choice{pointer-events:auto;cursor:pointer;border-radius:10px;padding:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}button{pointer-events:auto;cursor:pointer;background:#4f79ff;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:700}.tui{position:absolute;inset:0;pointer-events:none}#joy{position:absolute;left:calc(14px + env(safe-area-inset-left));bottom:calc(14px + env(safe-area-inset-bottom));width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);pointer-events:auto;touch-action:none}#joy #nub{position:absolute;left:50%;top:50%;width:56px;height:56px;margin:-28px 0 0 -28px;border-radius:50%;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);transition:transform .03s}.mbtn{position:absolute;right:calc(14px + env(safe-area-inset-right));bottom:calc(14px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:10px;pointer-events:auto}.mbtn button{width:54px;height:54px;border-radius:12px;background:#4f79ff;color:#fff;opacity:.9}@media (hover:hover) and (pointer:fine){.tui{display:none}}</style></head><body><div id="wrap"><canvas id="game"></canvas><!-- Menu --><div class="menu" id="menu"><div class="panel"><h3 style="margin:0 0 6px 0">모드 선택</h3><div class="row"><div>클래식 모드</div></div><div class="row" style="justify-content:flex-end"><button id="start">게임 시작</button></div><div style="opacity:.7;font-size:12px">Tip: 옵션은 시작 전 한 번만 적용. (R 재시작)</div></div></div><!-- HUD --><div class="hud"><div class="top"><div class="chip"><div style="opacity:.75">HP</div><div class="hp"><div id="hp" style="width:100%"></div></div></div><div class="chip"><span style="opacity:.75">LV</span> <b id="lv">1</b> · <span style="opacity:.75">XP</span> <b id="xpTxt">0/10</b></div><div class="chip"><span style="opacity:.75">TIME</span> <b id="tm">00:00</b> · <span style="opacity:.75">KILLS</span> <b id="ks">0</b></div><div class="chip"><span style="opacity:.75">STAGE</span> <b id="st">1</b>/5</div><div class="chip"><span style="opacity:.75">SCORE</span> <b id="sc">0</b></div></div><div class="bossw" id="bw"><div style="opacity:.75;margin:0 0 4px 2px">Boss HP</div><div class="boss"><div id="bf" style="width:0%"></div></div></div><div class="xp"><div id="xp" style="width:0%"></div></div><div class="help" id="help"><div style="font-weight:800">PC: WASD / ←↑→↓ 이동</div><div>모바일: 좌측 조이스틱 이동 · 우측 버튼(Ⅱ/≡)</div><div>무기는 자동 발사됩니다 (보이는 적/보스만 조준)</div><div><kbd>P</kbd> 일시정지 · <kbd>R</kbd> 재시작</div></div><div class="pause" id="pause">PAUSED</div><div class="badge" id="badge">STAGE 1</div><div class="tui" id="tui"><div id="joy"><div id="nub"></div></div><div class="mbtn"><button id="btnPause">Ⅱ</button><button id="btnMenu">≡</button></div></div></div><!-- LevelUp --><div class="modal" id="lvup"><div class="card"><h3 id="mt">레벨 업! 업그레이드를 선택</h3><div class="choices" id="choices"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button id="reroll">리롤 (1회)</button><button id="skip">건너뛰기</button></div></div></div></div><script>(()=>{const $=id=>document.getElementById(id),C=$("game").getContext("2d");const HP=$("hp"),XP=$("xp"),XT=$("xpTxt"),LV=$("lv"),TM=$("tm"),KS=$("ks"),ST=$("st"),SC=$("sc"),HELP=$("help"),BW=$("bw"),BF=$("bf"),BADGE=$("badge"),LVUP=$("lvup"),CHO=$("choices"),SKIP=$("skip"),REROLL=$("reroll"),MENU=$("menu"),START=$("start"),PAUSE=$("pause");const JOYEL=$("joy"), NUB=$("nub"), BTNPAUSE=$("btnPause"), BTNMENU=$("btnMenu");const r=(a,b)=>Math.random()*(b-a)+a,cl=(v,a,b)=>Math.max(a,Math.min(b,v)),ds=(x1,y1,x2,y2)=>{const dx=x2-x1,dy=y2-y1;return dx*dx+dy*dy},d=(x1,y1,x2,y2)=>Math.hypot(x2-x1,y2-y1),L=(a,b,t)=>a+(b-a)*t,N=()=>performance.now();let G;function R(){const dpr=Math.min(devicePixelRatio||1,2),cv=$("game");cv.width=Math.floor(cv.clientWidth*dpr);cv.height=Math.floor(cv.clientHeight*dpr);C.setTransform(dpr,0,0,dpr,0,0)}addEventListener("resize",R);const K=new Set;addEventListener("keydown",e=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","Tab"].includes(e.key))e.preventDefault();K.add(e.key.toLowerCase())});addEventListener("keyup",e=>K.delete(e.key.toLowerCase()));
// Mobile joystick setup
const JOY={active:false,id:null,dx:0,dy:0};if(JOYEL&&NUB){const rect=()=>JOYEL.getBoundingClientRect();const limit=()=>Math.min(rect().width,rect().height)/2-6;const setNub=(dx,dy)=>{NUB.style.transform=`translate(${dx}px,${dy}px)`};const onMove=e=>{const r=rect();const cx=r.left+r.width/2,cy=r.top+r.height/2;let dx=e.clientX-cx,dy=e.clientY-cy;const Lm=limit();const m=Math.hypot(dx,dy)||1;if(m>Lm){dx=dx/m*Lm;dy=dy/m*Lm}JOY.dx=dx/Lm;JOY.dy=dy/Lm;setNub(dx,dy)};const end=()=>{JOY.active=false;JOY.id=null;JOY.dx=0;JOY.dy=0;setNub(0,0)};JOYEL.addEventListener('pointerdown',e=>{JOY.active=true;JOY.id=e.pointerId;JOYEL.setPointerCapture(e.pointerId);onMove(e)});JOYEL.addEventListener('pointermove',e=>{if(JOY.active&&e.pointerId===JOY.id)onMove(e)});JOYEL.addEventListener('pointerup',e=>{if(e.pointerId===JOY.id)end()});JOYEL.addEventListener('pointercancel',end)}function hpMul(s){if(s<=2)return 1;return Math.min(1+(s-2)*.08,1.25)}function spInt(){const b=cl(G.spawnInt-G.minute*60-(G.stage-1)*120,1400,G.spawnInt);return G.boss?b*G.cfg.bossSlow:b}class P{constructor(x,y){this.x=x;this.y=y;this.r=14;this.bs=200;this.sm=1;this.hp=6;this.mhp=6;this.iv=0;this.xp=0;this.lv=1;this.nx=10;this.pick=160;this.fi=700;this.last=0;this.ps=560;this.pd=2;this.pc=1;this.spread=16*Math.PI/180;this.orbit={lv:0,c:0,dm:1.5,rad:56,sp:1.6,or:[]};this.light={lv:0,last:0,int:1500,s:1,dm:5};this.scy={lv:0,c:0,dm:4,rad:110,sp:2,w:18,bl:[]};this.rail={lv:0,last:0,int:1200,dm:6,th:8};this.well={lv:0,last:0,int:6000,rad:120,dm:7,pull:2.0};this.shield={lv:0,ang:Math.PI/3,rad:46,dx:1,dy:0};this.tur={lv:0,last:0,int:10000,range:300,dm:2.0,mx:1,pierce:0,cd:0.6};this.mine={lv:0,last:0,int:400,dm:4,rad:90,mx:6,slow:false};this.vb={lv:0,last:0,int:3000,dm:9,len:180,rad:12,extra:0,speed:220,dur:3}}get sp(){return this.bs*this.sm}addXP(v){this.xp+=v;while(this.xp>=this.nx){this.xp-=this.nx;this.lv++;this.nx=Math.floor(this.nx*1.2+6);Q()}}hurt(dm){if(this.iv>0)return;this.hp-=dm*G.cfg.emD;this.iv=.6;if(this.hp<=0)GO(false)}heal(v){this.hp=cl(this.hp+v,0,this.mhp)}}class E{constructor(x,y,t=0){this.x=x;this.y=y;this.t=t;if(t===0){this.r=12;this.hp=4;this.s=85;this.dm=1}if(t===1){this.r=9;this.hp=3;this.s=130;this.dm=1}if(t===2){this.r=18;this.hp=10;this.s=58;this.dm=2}if(t===3){this.r=13;this.hp=5;this.s=80;this.dm=1;this.cd=r(1.0,1.6);this.rate=G.cfg.sr}const s=G.stage;this.hp=Math.ceil(this.hp*hpMul(s));this.s=Math.ceil(this.s*(1+(s-1)*.05));this.k=0;this.vx=0;this.vy=0;this.slowt=0;this.dead=false}u(dt){if(this.dead)return;const p=G.p;let dx=p.x-this.x,dy=p.y-this.y;const m=Math.hypot(dx,dy)||1;dx/=m;dy/=m;const slowF=this.slowt>0?0.6:1;this.slowt=Math.max(0,this.slowt-dt);const sp=(this.s+G.minute*5)*slowF,kk=this.k;this.vx=dx*sp+(kk>0?-dx*220:0);this.vy=dy*sp+(kk>0?-dy*220:0);this.x+=this.vx*dt;this.y+=this.vy*dt;this.k=Math.max(0,kk-dt);if(this.t===3){this.cd-=dt;if(this.cd<=0){this.cd=this.rate*(.9-Math.min(.5,G.minute*.02));const spd=260;const vx=(p.x-this.x)/m*spd,vy=(p.y-this.y)/m*spd;G.eb.push({x:this.x,y:this.y,vx:vx,vy:vy,r:5,dm:1,life:4})}}}}class B{constructor(){this.x=r(200,2800);this.y=r(200,1800);this.r=34;this.mhp=750;this.hp=this.mhp;this.s=85;this.dm=2;this.dead=false;this.cool=0;this.cd=2.2}u(dt){if(this.dead)return;const p=G.p;let dx=p.x-this.x,dy=p.y-this.y;const m=Math.hypot(dx,dy)||1;dx/=m;dy/=m;this.x+=dx*this.s*dt;this.y+=dy*this.s*dt;this.cool-=dt;if(this.cool<=0){this.cool=this.cd;this.shot()}}shot(){const n=12,sp=220;for(let i=0;i<n;i++){const a=i*(Math.PI*2/n);G.eb.push({x:this.x,y:this.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,r:5,dm:1,life:4})}}}class PR{constructor(x,y,dx,dy){this.x=x;this.y=y;const n=Math.hypot(dx,dy)||1;dx/=n;dy/=n;this.vx=dx*G.p.ps;this.vy=dy*G.p.ps;this.r=6;this.dm=G.p.pd;this.life=1.8;this.pi=0}u(dt){this.x+=this.vx*dt;this.y+=this.vy*dt;this.life-=dt;if(this.life<=0)this.dead=true}}class GM{constructor(x,y,v){this.x=x;this.y=y;this.r=6;this.v=v;this.vx=0;this.vy=0;this.c=false}}class PT{constructor(x,y,c,life=.4){this.x=x;this.y=y;this.c=c;this.life=life;this.r=4}u(dt){this.life-=dt;this.r+=20*dt;this.dead=this.life<=0}}class BT{constructor(x1,y1,x2,y2,life=.12){this.x1=x1;this.y1=y1;this.x2=x2;this.y2=y2;this.life=life}u(dt){this.life-=dt;this.dead=this.life<=0}}function reset(cfg){const CF=cfg||DEF.classic;G={cfg:{...CF},p:new P(1500,1000),en:[],pr:[],gm:[],pt:[],bt:[],eb:[],boss:null,time:0,minute:0,kills:0,last:0,spawnInt:CF.spawn,paused:false,over:false,clear:false,cam:{x:0,y:0,s:.12},stage:1,bs:false,score:0,wl:[],tr:[],mn:[],vb:[]};LQ.length=0;LVUP.classList.remove("show");BW.style.display='none';BF.style.width='0%';ST.textContent=G.stage;BADGE.textContent='STAGE '+G.stage;BADGE.classList.add('show');setTimeout(()=>BADGE.classList.remove('show'),900);U()}function GO(c){G.over=true;G.clear=!!c;G.score=Math.floor(G.kills*10+G.time*2+(G.clear?500:0));LVUP.classList.add('show');$("mt").textContent=G.clear?'클리어! 승리':'게임 종료';CHO.innerHTML=`<div class="choice" data-a="restart"><div class="t">다시 시작</div><div style="opacity:.8">${F(G.time)} 생존 · ${G.kills} 처치 · ${G.score} 점</div></div><div class="choice" data-a="menu"><div class="t">메뉴로</div><div style="opacity:.8">모드/설정 재선택</div></div>`}function U(){const p=G.p;HP.style.width=(p.hp/p.mhp*100)+'%';XP.style.width=(p.xp/p.nx*100)+'%';XT.textContent=(p.xp|0)+'/'+p.nx;LV.textContent=p.lv;TM.textContent=F(G.time);KS.textContent=G.kills;SC.textContent=G.score|0;ST.textContent=G.stage;BW.style.display=G.boss?'block':'none';if(G.boss)BF.style.width=(G.boss.hp/G.boss.mhp*100)+'%'}const LQ=[];let CAN_REROLL=false;function Q(){LQ.push(1);G.paused=true;showLU()}const UPS=[{k:'speed',t:'이동 속도 +10%',d:'속도 증가',ap:()=>G.p.sm*=1.1},{k:'fire',t:'공격 속도 +15%',d:'발사 간격 감소',ap:()=>G.p.fi=Math.max(200,Math.floor(G.p.fi*.85))},{k:'multi',t:'탄환 +1',d:'동시 발사 +1',ap:()=>G.p.pc=Math.min(6,G.p.pc+1)},{k:'dmg',t:'공격력 +1',d:'탄 피해 +1',ap:()=>G.p.pd+=1},{k:'mag',t:'자석 +20%',d:'보석 흡입 증가',ap:()=>G.p.pick*=1.2},{k:'hp',t:'최대 HP +1 & 회복',d:'최대 1 증가',ap:()=>{G.p.mhp+=1;G.p.heal(1)}},{k:'o_u',t:'[신규] 원형 궤도',d:'구체 2개 생성',ap:()=>{const o=G.p.orbit;if(o.lv===0){o.lv=1;o.c=2;for(let i=0;i<o.c;i++)o.or.push({a:i*(Math.PI*2/o.c)})}}},{k:'o_p',t:'원형 궤도 +1',d:'구체 +1, 피해 +10%',ap:()=>{const o=G.p.orbit;if(o.lv>0){o.c++;o.dm*=1.1;o.or.push({a:0})}}},{k:'o_s',t:'원형 궤도 가속',d:'회전 +25%',ap:()=>{const o=G.p.orbit;if(o.lv>0)o.sp*=1.25}},{k:'l_u',t:'[신규] 번개',d:'주기적 낙뢰',ap:()=>{const l=G.p.light;if(l.lv===0){l.lv=1;l.int=1400;l.s=1}}},{k:'l_m',t:'번개 대상 +1',d:'동시 타격 +1',ap:()=>{const l=G.p.light;if(l.lv>0)l.s++}},{k:'l_p',t:'번개 피해 +30%',d:'피해↑ 재사용↓',ap:()=>{const l=G.p.light;if(l.lv>0){l.dm=Math.round(l.dm*1.3);l.int=Math.max(700,Math.floor(l.int*.9))}}},{k:'s_u',t:'[신규] 회전낫',d:'큰 낫 1개',ap:()=>{const s=G.p.scy;if(s.lv===0){s.lv=1;s.c=1;s.bl=[{a:0}]}}},{k:'s_p',t:'회전낫 +1',d:'낫 +1, 피해 +15%',ap:()=>{const s=G.p.scy;if(s.lv>0){s.c++;s.dm=Math.round(s.dm*1.15);s.bl.push({a:0})}}},{k:'s_s',t:'회전낫 가속',d:'회전 +25%',ap:()=>{const s=G.p.scy;if(s.lv>0)s.sp*=1.25}},
// Railgun
{k:'rg_u',t:'[신규] 레일건',d:'관통 빔 저격',ap:()=>{const g=G.p.rail;if(g.lv===0)g.lv=1}},
{k:'rg_c',t:'레일건 쿨다운 -15%',d:'더 잦은 빔',ap:()=>{const g=G.p.rail;if(g.lv>0)g.int=Math.max(500,Math.floor(g.int*0.85))}},
{k:'rg_p',t:'레일건 피해 +30%',d:'강력한 저격',ap:()=>{const g=G.p.rail;if(g.lv>0)g.dm=Math.round(g.dm*1.3)}},
// Gravity Well
{k:'gw_u',t:'[신규] 중력 우물',d:'끌어모아 폭발',ap:()=>{const g=G.p.well;if(g.lv===0)g.lv=1}},
{k:'gw_c',t:'우물 쿨다운 -20%',d:'더 자주 생성',ap:()=>{const g=G.p.well;if(g.lv>0)g.int=Math.max(2500,Math.floor(g.int*0.8))}},
{k:'gw_r',t:'우물 반경 +25%',d:'더 넓게 흡인',ap:()=>{const g=G.p.well;if(g.lv>0)g.rad=Math.round(g.rad*1.25)}},
// Reflect Shield
{k:'sh_u',t:'[신규] 반사 방패',d:'전방 탄환 반사',ap:()=>{const g=G.p.shield;if(g.lv===0)g.lv=1}},
{k:'sh_w',t:'방패 각도 +15°',d:'전방 커버 확대',ap:()=>{const g=G.p.shield;if(g.lv>0)g.ang=Math.min(Math.PI*0.95,g.ang+Math.PI/12)}},
{k:'sh_r',t:'방패 반경 +15%',d:'몸 가까이 보호',ap:()=>{const g=G.p.shield;if(g.lv>0)g.rad=Math.round(g.rad*1.15)}},
// NEW: Turret
{k:'tu_u',t:'[신규] 감시포탑',d:'10초마다 자가 배치',ap:()=>{const g=G.p.tur;if(g.lv===0)g.lv=1}},
{k:'tu_mx',t:'포탑 최대수 +1',d:'동시 배치 증가',ap:()=>{const g=G.p.tur;if(g.lv>0)g.mx=Math.min(6,g.mx+1)}},
{k:'tu_r',t:'포탑 사거리 +20%',d:'범위 넓힘',ap:()=>{const g=G.p.tur;if(g.lv>0)g.range=Math.round(g.range*1.2)}},
{k:'tu_p',t:'포탑 꿰뚫기 +1',d:'탄환 관통 1회',ap:()=>{const g=G.p.tur;if(g.lv>0)g.pierce=Math.min(2,g.pierce+1)}},
// NEW: Mines
{k:'mi_u',t:'[신규] 지뢰 살포',d:'이동 중 자동 살포',ap:()=>{const g=G.p.mine;if(g.lv===0)g.lv=1}},
{k:'mi_mx',t:'지뢰 최대수 +2',d:'더 많이 설치',ap:()=>{const g=G.p.mine;if(g.lv>0)g.mx=Math.min(20,g.mx+2)}},
{k:'mi_slow',t:'둔화 필드 1.5s',d:'폭발 시 둔화',ap:()=>{const g=G.p.mine;if(g.lv>0)g.slow=true}},
{k:'mi_r',t:'지뢰 반경 +25%',d:'폭발 범위↑',ap:()=>{const g=G.p.mine;if(g.lv>0)g.rad=Math.round(g.rad*1.25)}},
// NEW: Void Blade
{k:'vb_u',t:'[신규] 보이드 칼날',d:'앞으로 전진하는 드릴',ap:()=>{const g=G.p.vb;if(g.lv===0)g.lv=1}},
{k:'vb_l',t:'칼날 길이 +30%',d:'더 긴 범위',ap:()=>{const g=G.p.vb;if(g.lv>0)g.len=Math.round(g.len*1.3)}},
{k:'vb_d',t:'칼날 틱 피해 +25%',d:'더 아픔',ap:()=>{const g=G.p.vb;if(g.lv>0)g.dm=Math.round(g.dm*1.25)}},
{k:'vb_w',t:'칼날 두께 +25%',d:'굵은 블레이드',ap:()=>{const g=G.p.vb;if(g.lv>0)g.rad=Math.round(g.rad*1.25)}},
{k:'vb_x',t:'추가 칼날 +1',d:'교차 각도 추가',ap:()=>{const g=G.p.vb;if(g.lv>0)g.extra=Math.min(2,g.extra+1)}},];
function pool(){const B=['speed','fire','multi','dmg','mag','hp'],p=[];for(const k of B){const u=UPS.find(u=>u.k===k);if(u)p.push(u)}const o=G.p.orbit.lv,l=G.p.light.lv,s=G.p.scy.lv;p.push(UPS.find(u=>u.k==(o?'o_p':'o_u')));p.push(UPS.find(u=>u.k==(o?'o_s':'o_u')));if(!o)p.pop();p.push(UPS.find(u=>u.k==(l?'l_m':'l_u')));p.push(UPS.find(u=>u.k==(l?'l_p':'l_u')));if(!l)p.pop();p.push(UPS.find(u=>u.k==(s?'s_p':'s_u')));p.push(UPS.find(u=>u.k==(s?'s_s':'s_u')));if(!s)p.pop();
const rg=G.p.rail.lv;p.push(UPS.find(u=>u.k==(rg? 'rg_c':'rg_u')));p.push(UPS.find(u=>u.k==(rg? 'rg_p':'rg_u')));if(!rg)p.pop();
const gw=G.p.well.lv;p.push(UPS.find(u=>u.k==(gw? 'gw_c':'gw_u')));p.push(UPS.find(u=>u.k==(gw? 'gw_r':'gw_u')));if(!gw)p.pop();
const sh=G.p.shield.lv;p.push(UPS.find(u=>u.k==(sh? 'sh_w':'sh_u')));p.push(UPS.find(u=>u.k==(sh? 'sh_r':'sh_u')));if(!sh)p.pop();
const tu=G.p.tur.lv;p.push(UPS.find(u=>u.k==(tu? 'tu_mx':'tu_u')));p.push(UPS.find(u=>u.k==(tu? 'tu_r':'tu_u')));p.push(UPS.find(u=>u.k==(tu? 'tu_p':'tu_u')));if(!tu){p.pop();p.pop()}
const mi=G.p.mine.lv;p.push(UPS.find(u=>u.k==(mi? 'mi_mx':'mi_u')));p.push(UPS.find(u=>u.k==(mi? 'mi_slow':'mi_u')));p.push(UPS.find(u=>u.k==(mi? 'mi_r':'mi_u')));if(!mi){p.pop();p.pop()}
const vb=G.p.vb.lv;p.push(UPS.find(u=>u.k==(vb? 'vb_l':'vb_u')));p.push(UPS.find(u=>u.k==(vb? 'vb_d':'vb_u')));p.push(UPS.find(u=>u.k==(vb? 'vb_w':'vb_u')));p.push(UPS.find(u=>u.k==(vb? 'vb_x':'vb_u')));if(!vb){p.pop();p.pop();p.pop()}
return p.filter(Boolean)}
function buildChoicesHTML(){const p=pool(),n=Math.min(3,p.length),idx=new Set;while(idx.size<n)idx.add(Math.floor(Math.random()*p.length));return [...idx].map(i=>{const u=p[i];return `<div class="choice" data-k="${u.k}"><div><b>${u.t}</b></div><div style="opacity:.8">${u.d}</div></div>`}).join('')}
function renderChoices(){CHO.innerHTML=buildChoicesHTML()}
function showLU(){LVUP.classList.add('show');PAUSE.style.display='block';renderChoices();CAN_REROLL=true;REROLL.disabled=false;REROLL.textContent='리롤 (1회)'; if(REROLL) REROLL.style.display='inline-block'; if(SKIP) SKIP.style.display='inline-block';}
function hideLU(){LVUP.classList.remove('show');PAUSE.style.display='none'}
function doReroll(){if(!CAN_REROLL)return;renderChoices();CAN_REROLL=false;REROLL.disabled=true;REROLL.textContent='리롤 완료'}
CHO.addEventListener('click',e=>{const c=e.target.closest('.choice');if(!c)return;const a=c.getAttribute('data-a');if(a==='restart'){reset(G.cfg);hideLU();HELP.style.display='block';return}if(a==='menu'){hideLU();showM();return}const k=c.getAttribute('data-k');const u=UPS.find(u=>u.k===k);if(u)u.ap();LQ.shift();if(LQ.length===0){hideLU();G.paused=false}else showLU();U()});
REROLL.addEventListener('click',()=>doReroll());
// Override GO to ensure game pauses and level-up controls are hidden on game over
GO = function(c){
  G.over = true;
  G.clear = !!c;
  G.score = Math.floor(G.kills*10 + G.time*2 + (G.clear?500:0));
  G.paused = true;
  PAUSE.style.display = 'block';
  LVUP.classList.add('show');
  $("mt").textContent = G.clear ? '클리어! 승리' : '게임 종료';
  CHO.innerHTML = `<div class="choice" data-a="restart"><div class="t">다시 시작</div><div style="opacity:.8">${F(G.time)} 생존 · ${G.kills} 처치 · ${G.score} 점</div></div><div class="choice" data-a="menu"><div class="t">메뉴로</div><div style="opacity:.8">모드/설정 재선택</div></div>`;
  if (REROLL) REROLL.style.display = 'none';
  if (SKIP) SKIP.style.display = 'none';
};
SKIP.addEventListener('click',()=>{if(G.over){reset(G.cfg);hideLU();return}G.p.xp=Math.min(G.p.xp+Math.ceil(G.p.nx*.05),G.p.nx-1);LQ.shift();if(!LQ.length){hideLU();G.paused=false}else showLU();U()});
addEventListener('keydown',e=>{const k=e.key.toLowerCase();if(k==='p'){G.paused=!G.paused;PAUSE.style.display=G.paused?'block':'none'}if(k==='r'){showM();reset(DEF.classic)}});let LAST=0;function loop(t){if(!LAST)LAST=t;const dt=Math.min(.033,(t-LAST)/1000);LAST=t;upd(dt);drw();requestAnimationFrame(loop)}
// Target only visible enemies/boss
function isOnScreen(x,y,r=0){const cv=$("game"),vw=cv.clientWidth,vh=cv.clientHeight;const minX=G.cam.x-vw/2,maxX=G.cam.x+vw/2,minY=G.cam.y-vh/2,maxY=G.cam.y+vh/2;return x+r>=minX&&x-r<=maxX&&y+r>=minY&&y-r<=maxY}
function tgt(px,py){let best=null,bd=Infinity,bh=Infinity;const eps=1e-3;for(const e of G.en){if(e.dead)continue;if(!isOnScreen(e.x,e.y,e.r))continue;const dd=ds(px,py,e.x,e.y);if(dd<bd-eps||(Math.abs(dd-bd)<=eps&&e.hp<bh)){bd=dd;bh=e.hp;best=e}}if(G.boss&&isOnScreen(G.boss.x,G.boss.y,G.boss.r)){const db=ds(px,py,G.boss.x,G.boss.y),bhb=G.boss.hp;if(db<bd-eps||(Math.abs(db-bd)<=eps&&bhb<bh)){best=G.boss;bd=db;bh=bhb}}return best}
// New systems
function updRail(dt){const l=G.p.rail;if(l.lv===0)return;l.last+=dt*1000;if(l.last<l.int)return;l.last=0;const p=G.p;const tg=tgt(p.x,p.y);if(!tg)return;const ang=Math.atan2(tg.y-p.y,tg.x-p.x);const len=1800;const x2=p.x+Math.cos(ang)*len,y2=p.y+Math.sin(ang)*len;G.bt.push(new BT(p.x,p.y,x2,y2,.08));const thick=l.th;const hitLine=(cx,cy,rr)=>{const x1=p.x,y1=p.y;const vx=x2-x1,vy=y2-y1;const wx=cx-x1,wy=cy-y1;const vv=vx*vx+vy*vy;let t=(vx*wx+vy*wy)/(vv||1);t=cl(t,0,1);const px=x1+vx*t,py=y1+vy*t;const dist2=ds(px,py,cx,cy);return dist2<=Math.pow(rr+thick,2)};for(const en of G.en){if(en.dead)continue;if(hitLine(en.x,en.y,en.r)){en.hp-=l.dm;en.k=.12;if(en.hp<=0){en.dead=true;G.kills++;drop(en.x,en.y)}}}if(G.boss&&hitLine(G.boss.x,G.boss.y,G.boss.r)){G.boss.hp-=Math.max(1,Math.round(l.dm*0.7));}}
function updWell(dt){const w=G.p.well;if(w.lv===0)return;w.last+=dt*1000;for(const wl of G.wl){wl.t+=dt;if(wl.phase==='pull'&&wl.t>=wl.pull){wl.phase='boom';wl.t=0;let kills=0;for(const en of G.en){if(en.dead)continue;const dist=d(wl.x,wl.y,en.x,en.y);if(dist<=wl.rad){en.hp-=w.dm;en.k=.3;if(G.p.mine.slow)en.slowt=Math.max(en.slowt,1.5);if(en.hp<=0){en.dead=true;kills++;G.kills++;drop(en.x,en.y)}}}if(G.boss){const db=d(wl.x,wl.y,G.boss.x,G.boss.y);if(db<=wl.rad)G.boss.hp-=Math.max(1,Math.round(w.dm*0.6))}G.pt.push(new PT(wl.x,wl.y,'rgba(180,220,255,.35)',.25));}if(wl.phase==='pull'){for(const en of G.en){if(en.dead)continue;const dist=d(wl.x,wl.y,en.x,en.y);if(dist<=wl.rad*1.4){const ax=(wl.x-en.x)/Math.max(1,dist),ay=(wl.y-en.y)/Math.max(1,dist);en.x+=ax*w.pull*40*dt;en.y+=ay*w.pull*40*dt}}}
 if(wl.phase==='boom'&&wl.t>=.12){wl.dead=true}}
G.wl=G.wl.filter(x=>!x.dead);
if(w.last>=w.int){w.last=0;let cx=G.p.x,cy=G.p.y; if(G.en.length){const ns=nearN(G.p.x,G.p.y,4,680); if(ns.length){cx=ns.reduce((s,e)=>s+e.x,0)/ns.length; cy=ns.reduce((s,e)=>s+e.y,0)/ns.length;}} G.wl.push({x:cx,y:cy,rad:w.rad,phase:'pull',t:0,pull:w.pull});}}
function updShieldPrep(ax,ay){const sh=G.p.shield;if(sh.lv===0)return;const m=Math.hypot(ax,ay);if(m>0.2){sh.dx=ax/m;sh.dy=ay/m}}
function tryReflectBullet(b){const sh=G.p.shield;if(sh.lv===0)return false;const p=G.p;const vx=b.x-p.x,vy=b.y-p.y;const dist=Math.hypot(vx,vy);if(dist>sh.rad+b.r)return false;const vm=Math.hypot(vx,vy)||1;const ux=vx/vm,uy=vy/vm;const dot=ux*sh.dx+uy*sh.dy;const lim=Math.cos(sh.ang/2);if(dot<lim)return false;const sp=Math.hypot(b.vx,b.vy)||260;const rx=ux,ry=uy;const pr=new PR(b.x,b.y,rx,ry);pr.dm=Math.max(1,Math.round(1.5));G.pr.push(pr);G.pt.push(new PT(b.x,b.y,'rgba(180,220,255,.28)',.15));b.life=0;return true}
function updTurrets(dt){const t=G.p.tur;if(t.lv===0)return;t.last+=dt*1000;if(t.last>=t.int){t.last=0;G.tr.push({x:G.p.x,y:G.p.y,last:0});if(G.tr.length>t.mx)G.tr.shift()}for(const tu of G.tr){tu.last-=dt; if(tu.last<=0){tu.last=t.cd; let target=null,bd=1e9; for(const e of G.en){if(e.dead)continue;const dd=ds(tu.x,tu.y,e.x,e.y);if(dd<bd&&(Math.sqrt(dd)<=t.range)){bd=dd;target=e}} if(G.boss){const db=ds(tu.x,tu.y,G.boss.x,G.boss.y);if(Math.sqrt(db)<=t.range && db<bd){target=G.boss;bd=db}} if(target){const ang=Math.atan2(target.y-tu.y,target.x-tu.x);const pr=new PR(tu.x,tu.y,Math.cos(ang),Math.sin(ang));pr.dm=t.dm;pr.pi=t.pierce;G.pr.push(pr)}}}}
function updMines(dt,ax,ay){const m=G.p.mine;if(m.lv===0)return;const moving=Math.hypot(ax,ay)>0.2;m.last+=dt*1000; if(moving && m.last>=m.int){m.last=0;G.mn.push({x:G.p.x,y:G.p.y,arm:0,tr:0,boom:false}); if(G.mn.length>m.mx)G.mn.shift()} for(const mn of G.mn){ if(mn.boom)continue; const enemy=nearN(mn.x,mn.y,1,90)[0]; if(enemy){mn.tr+=dt; if(mn.tr>=0.2){mn.boom=true; // explode
 const rad=m.rad; for(const en of G.en){if(en.dead)continue; if(d(mn.x,mn.y,en.x,en.y)<=rad){en.hp-=m.dm;en.k=.35; if(m.slow)en.slowt=Math.max(en.slowt,1.5); if(en.hp<=0){en.dead=true;G.kills++;drop(en.x,en.y)}}} if(G.boss&&d(mn.x,mn.y,G.boss.x,G.boss.y)<=m.rad){G.boss.hp-=Math.max(1,Math.round(m.dm*0.5))} G.pt.push(new PT(mn.x,mn.y,'rgba(200,220,255,.4)',.22)); } } }
G.mn=G.mn.filter(x=>!x.boom)}
function updBlades(dt){const v=G.p.vb;if(v.lv===0)return;v.last+=dt*1000;if(v.last>=v.int){v.last=0; let ax=G.shx||0, ay=G.shy||0; let best=null,bd=1e9; for(const e of G.en){ if(e.dead)continue; const dd=ds(G.p.x,G.p.y,e.x,e.y); if(dd<bd){bd=dd; best={x:e.x,y:e.y} } } if(G.boss){ const db=ds(G.p.x,G.p.y,G.boss.x,G.boss.y); if(db<bd){ best={x:G.boss.x,y:G.boss.y} } } if(best){ ax=best.x-G.p.x; ay=best.y-G.p.y; } if(ax===0&&ay===0){ ax=1; ay=0; } const baseAng=Math.atan2(ay,ax); const angs=[baseAng]; if(v.extra>=1)angs.push(angs[0]+15*Math.PI/180); if(v.extra>=2)angs.push(angs[0]-15*Math.PI/180); for(const a of angs){G.vb.push({x:G.p.x,y:G.p.y,vx:Math.cos(a)*v.speed,vy:Math.sin(a)*v.speed,len:v.len,rad:v.rad,life:v.dur})}}
for(const bl of G.vb){bl.x+=bl.vx*dt;bl.y+=bl.vy*dt;bl.life-=dt; const x1=bl.x, y1=bl.y; const spd=Math.hypot(bl.vx,bl.vy)||1; const dx=bl.vx/spd, dy=bl.vy/spd; const x2=bl.x+dx*bl.len, y2=bl.y+dy*bl.len; const hitCap=(cx,cy,rr)=>{const vx=x2-x1,vy=y2-y1;const wx=cx-x1,wy=cy-y1;const vv=vx*vx+vy*vy;let t=(vx*wx+vy*wy)/(vv||1);t=cl(t,0,1);const px=x1+vx*t,py=y1+vy*t;return ds(px,py,cx,cy)<=Math.pow(rr+bl.rad,2)}; for(const en of G.en){if(en.dead)continue; if(hitCap(en.x,en.y,en.r)){en.hp-=G.p.vb.dm*dt; en.k=.05; if(en.hp<=0){en.dead=true;G.kills++;drop(en.x,en.y)}}} if(G.boss&&hitCap(G.boss.x,G.boss.y,G.boss.r)){G.boss.hp-=Math.max(1,Math.round(G.p.vb.dm*0.5*dt))}}
G.vb=G.vb.filter(b=>b.life>0)}
function upd(dt){if(!G||G.paused)return;if(!G.over){G.time+=dt;G.minute=Math.floor(G.time/60);G.score+=dt*2}const p=G.p;let ax=0,ay=0;if(JOY&&JOY.active){ax+=JOY.dx;ay+=JOY.dy}if(K.has('arrowleft')||K.has('a'))ax-=1;if(K.has('arrowright')||K.has('d'))ax+=1;if(K.has('arrowup')||K.has('w'))ay-=1;if(K.has('arrowdown')||K.has('s'))ay+=1;if(ax||ay){const n=Math.hypot(ax,ay);ax/=n;ay/=n;HELP.style.display='none'}G.shx=ax;G.shy=ay;updShieldPrep(ax,ay);p.x+=ax*p.sp*dt;p.y+=ay*p.sp*dt;p.x=cl(p.x,0,3000);p.y=cl(p.y,0,2000);if(p.iv>0)p.iv-=dt;const ns=Math.min(5,Math.floor(G.time/60)+1);if(ns!==G.stage){G.stage=ns;ST.textContent=G.stage;BADGE.textContent='STAGE '+G.stage;BADGE.classList.add('show');setTimeout(()=>BADGE.classList.remove('show'),800)}if(G.cfg.boss&&G.stage===5&&!G.bs){G.boss=new B;G.bs=true;BW.style.display='block'}G.cam.x=L(G.cam.x,p.x,G.cam.s);G.cam.y=L(G.cam.y,p.y,G.cam.s);
const T=N();if(T-p.last>=p.fi){const tg=tgt(p.x,p.y);if(tg){const ang=Math.atan2(tg.y-p.y,tg.x-p.x),cnt=p.pc,sp=p.spread*(Math.max(0,cnt-1));for(let i=0;i<cnt;i++){const a=ang-(cnt>1?sp/2:0)+(cnt>1?i*(sp/(cnt-1)):0);G.pr.push(new PR(p.x,p.y,Math.cos(a),Math.sin(a)))}G.pt.push(new PT(p.x,p.y,'rgba(110,180,255,.45)',.25));p.last=T}}
updRail(dt);updTurrets(dt);updOrbit(dt);updLight(dt);updScy(dt);updMines(dt,ax,ay);updBlades(dt);
G.last+=dt*1000;const it=spInt();if(G.last>=it){wave(G.boss?0.6:1);G.last=0}
for(const e of G.en)e.u(dt);if(G.boss)G.boss.u(dt);updWell(dt);
for(const pr of G.pr)pr.u(dt);
for(const pr of G.pr){if(pr.dead)continue;for(const en of G.en){if(en.dead)continue;const rr=(6+en.r);if(ds(pr.x,pr.y,en.x,en.y)<=rr*rr){en.hp-=pr.dm;pr.pi>0?pr.pi--:pr.dead=true;en.k=.15;G.pt.push(new PT(en.x,en.y,'rgba(255,110,110,.5)',.2));if(en.hp<=0){en.dead=true;G.kills++;drop(en.x,en.y)}if(pr.dead)break}}if(G.boss&&!pr.dead){const rr=(6+G.boss.r);if(ds(pr.x,pr.y,G.boss.x,G.boss.y)<=rr*rr){G.boss.hp-=pr.dm;pr.pi>0?pr.pi--:pr.dead=true;G.pt.push(new PT(G.boss.x,G.boss.y,'rgba(255,150,90,.5)',.25));if(G.boss.hp<=0){G.boss.dead=true;G.boss=null;GO(true)}}}}
for(const b of G.eb){b.x+=b.vx*dt;b.y+=b.vy*dt;b.life-=dt;if(b.life<=0)continue;if(tryReflectBullet(b))continue; if(ds(b.x,b.y,p.x,p.y)<=(b.r+p.r)*(b.r+p.r)){p.hurt(b.dm);b.life=0}}
G.eb=G.eb.filter(b=>b.life>0);
G.en=G.en.filter(e=>!e.dead&&e.x>-220&&e.y>-220&&e.x<3220&&e.y<2220);
G.pr=G.pr.filter(p=>!p.dead);
for(const g of G.gm){const dd=d(g.x,g.y,p.x,p.y);if(dd<p.pick){const dx=(p.x-g.x)/Math.max(1,dd),dy=(p.y-g.y)/Math.max(1,dd);g.vx=dx*(320+(G.cfg.xpm-1)*60);g.vy=dy*(320+(G.cfg.xpm-1)*60)}g.x+=g.vx*dt;g.y+=g.vy*dt;g.vx*=.92;g.vy*=.92;if(ds(g.x,g.y,p.x,p.y)<=(g.r+p.r)*(g.r+p.r)){g.c=true;G.p.addXP(Math.max(1,Math.ceil(g.v)));G.pt.push(new PT(p.x,p.y,'rgba(122,162,255,.5)',.18))}}G.gm=G.gm.filter(g=>!g.c);
for(const pa of G.pt)pa.u(dt);G.pt=G.pt.filter(p=>!p.dead);
for(const bo of G.bt)bo.u(dt);G.bt=G.bt.filter(b=>!b.dead);
U()}
function wave(m=1){const c=Math.max(1,Math.floor((2+G.minute*.4+(G.stage-1)*.6)*G.cfg.ef*m));for(let i=0;i<c;i++){const s=Math.floor(Math.random()*4),M=120;let x,y;if(s===0){x=r(0,3000);y=-M}if(s===1){x=3000+M;y=r(0,2000)}if(s===2){x=r(0,3000);y=2000+M}if(s===3){x=-M;y=r(0,2000)}let t=0;if((G.minute>=2||G.stage>=2)&&Math.random()<G.cfg.sc)t=3;else if((G.minute>=3||G.stage>=3)&&Math.random()<.12)t=2;else if((G.minute>=1||G.stage>=2)&&Math.random()<.30)t=1;G.en.push(new E(x,y,t))}}
function drop(x,y){const raw=1+(Math.random()<.1?3:0),v=Math.max(1,Math.ceil(raw*G.cfg.xpm));const g=new GM(x,y,v);g.vx=r(-30,30);g.vy=r(-30,30);G.gm.push(g)}
function updOrbit(dt){const o=G.p.orbit;if(o.lv===0)return;const p=G.p,n=o.c;if(o.or.length!==n){o.or=[];for(let i=0;i<n;i++)o.or.push({a:i*(Math.PI*2/n)})}for(let i=0;i<n;i++){const ob=o.or[i];ob.a+=o.sp*dt;const x=p.x+Math.cos(ob.a)*o.rad,y=p.y+Math.sin(ob.a)*o.rad;for(const en of G.en){if(en.dead)continue;const rr=(10+en.r);if(ds(x,y,en.x,en.y)<=rr*rr){en.hp-=o.dm*dt*3;en.k=.05;if(en.hp<=0){en.dead=true;G.kills++;drop(en.x,en.y)}}}if(G.boss){const rr=(14+G.boss.r);if(ds(x,y,G.boss.x,G.boss.y)<=rr*rr)G.boss.hp-=o.dm*dt*2.5}}}
function updLight(dt){const l=G.p.light;if(l.lv===0)return;l.last+=dt*1000;if(l.last<l.int)return;l.last=0;const T=nearN(G.p.x,G.p.y,l.s,520);for(const t of T){if(!t)continue;const x1=t.x+r(-12,12),y1=t.y-240;G.bt.push(new BT(x1,y1,t.x,t.y));t.hp-=l.dm;t.k=.1;if(t.hp<=0){t.dead=true;G.kills++;drop(t.x,t.y)}}if(G.boss&&T.length===0){const b=G.boss,x1=b.x+r(-12,12),y1=b.y-260;G.bt.push(new BT(x1,y1,b.x,b.y));b.hp-=Math.max(1,Math.round(l.dm*.6));if(b.hp<=0){b.dead=true;G.boss=null;GO(true)}}}
function updScy(dt){const s=G.p.scy;if(s.lv===0)return;const p=G.p,n=s.c;if(s.bl.length!==n){s.bl=[];for(let i=0;i<n;i++)s.bl.push({a:i*(Math.PI*2/n)})}for(const bl of s.bl){bl.a+=s.sp*dt;const tx=p.x+Math.cos(bl.a)*s.rad,ty=p.y+Math.sin(bl.a)*s.rad;for(const en of G.en){if(en.dead)continue;const rr=(s.w+en.r);if(ds(tx,ty,en.x,en.y)<=rr*rr){en.hp-=s.dm*dt*2.3;en.k=.2;if(en.hp<=0){en.dead=true;G.kills++;drop(en.x,en.y)}}}if(G.boss){const rr=(s.w+G.boss.r);if(ds(tx,ty,G.boss.x,G.boss.y)<=rr*rr)G.boss.hp-=s.dm*dt*1.8}}}
function nearN(x,y,n,rg){const a=[];for(const e of G.en){if(e.dead)continue;const di=d(x,y,e.x,e.y);if(rg&&di>rg)continue;a.push({e,di})}a.sort((x,y)=>x.di-y.di);return a.slice(0,n).map(o=>o.e)}
function F(t){const s=String(Math.floor(t%60)).padStart(2,'0'),m=String(Math.floor(t/60)).padStart(2,'0');return m+':'+s}
function drawBG(w,h){C.fillStyle="#0e141d";C.fillRect(0,0,3000,2000);C.strokeStyle='rgba(255,255,255,.05)';C.lineWidth=1;const step=80;C.save();C.translate(G?G.cam.x-w/2:1500-w/2,G?G.cam.y-h/2:1000-h/2);for(let x=-((G?G.cam.x:1500)%step);x<w+step;x+=step){C.beginPath();C.moveTo(x,0);C.lineTo(x,h);C.stroke()}for(let y=-((G?G.cam.y:1000)%step);y<h+step;y+=step){C.beginPath();C.moveTo(0,y);C.lineTo(w,y);C.stroke()}C.restore();C.strokeStyle='rgba(255,255,255,.12)';C.lineWidth=3;C.strokeRect(.5,.5,2999,1999)}
function drw(){const cv=$("game"),w=cv.clientWidth,h=cv.clientHeight;C.clearRect(0,0,w,h);const cx=G?G.cam.x:1500,cy=G?G.cam.y:1000,ox=Math.floor(w/2-cx),oy=Math.floor(h/2-cy);C.save();C.translate(ox,oy);drawBG(w,h);if(G){for(const g of G.gm){C.beginPath();C.arc(g.x,g.y,6,0,Math.PI*2);C.fillStyle='rgba(122,162,255,.9)';C.fill();C.strokeStyle='rgba(180,210,255,.6)';C.stroke()}for(const e of G.en){C.beginPath();C.arc(e.x,e.y,e.r,0,Math.PI*2);let f='rgba(255,140,170,.9)';if(e.t===1)f='rgba(255,190,120,.9)';if(e.t===2)f='rgba(255,120,120,.85)';if(e.t===3)f='rgba(190,140,255,.9)';C.fillStyle=f;C.fill()}if(G.boss){C.beginPath();C.arc(G.boss.x,G.boss.y,G.boss.r,0,Math.PI*2);C.fillStyle='rgba(255,100,70,.95)';C.fill()}for(const wv of G.wl){C.beginPath();C.arc(wv.x,wv.y,wv.rad,0,Math.PI*2);C.strokeStyle='rgba(180,220,255,.18)';C.lineWidth=2;C.stroke()}for(const tu of G.tr){C.beginPath();C.rect(tu.x-8,tu.y-8,16,16);C.fillStyle='rgba(150,180,255,.8)';C.fill();C.strokeStyle='rgba(210,230,255,.5)';C.stroke()}for(const mn of G.mn){C.beginPath();C.arc(mn.x,mn.y,7,0,Math.PI*2);C.fillStyle='rgba(200,210,255,.35)';C.fill();C.strokeStyle='rgba(220,230,255,.45)';C.stroke()}for(const bl of G.vb){C.beginPath();C.moveTo(bl.x,bl.y);{const sp=Math.hypot(bl.vx,bl.vy)||1;const dx=bl.vx/sp,dy=bl.vy/sp;C.lineTo(bl.x+dx*bl.len, bl.y+dy*bl.len);}C.lineWidth=bl.rad*2;C.strokeStyle='rgba(180,220,255,.25)';C.stroke()}for(const b of G.eb){C.beginPath();C.arc(b.x,b.y,5,0,Math.PI*2);C.fillStyle='rgba(255,180,120,.95)';C.fill()}for(const pr of G.pr){C.beginPath();C.arc(pr.x,pr.y,6,0,Math.PI*2);C.fillStyle='rgba(160,210,255,.95)';C.fill()}const o=G.p.orbit;if(o.lv>0){const p=G.p;for(const ob of o.or){const x=p.x+Math.cos(ob.a)*o.rad,y=p.y+Math.sin(ob.a)*o.rad;C.beginPath();C.arc(x,y,10,0,Math.PI*2);C.fillStyle='rgba(120,230,210,.95)';C.fill()}}const s=G.p.scy;if(s.lv>0){const p=G.p;for(const bl of s.bl){const cx=p.x,cy=p.y,tx=cx+Math.cos(bl.a)*s.rad,ty=cy+Math.sin(bl.a)*s.rad;C.beginPath();C.moveTo(cx,cy);C.lineTo(tx,ty);C.lineWidth=3;C.strokeStyle='rgba(200,230,255,.25)';C.stroke();C.beginPath();C.arc(tx,ty,s.w,0,Math.PI*2);C.fillStyle='rgba(180,220,255,.9)';C.fill()}}const p=G.p;C.beginPath();C.arc(p.x,p.y,p.r,0,Math.PI*2);C.fillStyle=(p.iv>0&&Math.floor(N()/80)%2===0)?'rgba(150,220,255,.6)':'rgba(110,220,200,.95)';C.fill();for(const bo of G.bt){C.beginPath();C.moveTo(bo.x1,bo.y1);C.lineTo(bo.x2,bo.y2);C.lineWidth=3;C.strokeStyle='rgba(180,220,255,.95)';C.stroke()}for(const pa of G.pt){C.beginPath();C.arc(pa.x,pa.y,pa.r,0,Math.PI*2);C.fillStyle=pa.c;C.fill()}}C.restore()}
function showM(){MENU.style.display='grid';G&&(G.paused=true);HELP&&(HELP.style.display='none')}function hideM(){MENU.style.display='none';G&&(G.paused=false);HELP&&(HELP.style.display='block')}
const DEF={classic:{mode:'classic',boss:true,endless:false,spawn:2600,bossSlow:1.8,ef:1,emD:1,xpm:2.0,sc:.05,sr:2.0},endless:{mode:'endless',boss:false,endless:true,spawn:2400,bossSlow:1,ef:1.1,emD:1,xpm:2.0,sc:.05,sr:2.0}};
function bindRange(id,vid,fmt){const el=$(id),sp=$(vid),upd=()=>sp.textContent=fmt(el.value);el.addEventListener('input',upd);upd()}
START.addEventListener('click',()=>{ reset(DEF.classic); hideM(); });BTNPAUSE&&BTNPAUSE.addEventListener('click',()=>{ G.paused=!G.paused; PAUSE.style.display=G.paused?'block':'none'; });BTNMENU&&BTNMENU.addEventListener('click',()=>{ showM(); });
function TESTS(){try{const sv={st:G.stage,b:G.boss,bs:G.bs,en:G.en.slice(),eb:G.eb.slice(),t:G.time,m:G.minute,x:G.p.xp,p:G.p.pick,last:G.last,cfg:{...G.cfg}};G.stage=Math.max(2,G.stage);G.en.length=0;let shooters=0,tot=220;for(let i=0;i<tot;i++)wave(1);shooters=G.en.filter(e=>e.t===3).length;const rate=shooters/(G.en.length||1);console.assert(rate<=.12,'Shooter rate too high',rate);if(G.cfg.mode==='classic'){G.boss=null;G.bs=false;G.stage=4;upd(0);console.assert(!G.bs,'No boss before 5');G.stage=5;G.boss=new B;console.assert(!!G.boss,'Boss at 5')}if(G.cfg.mode==='endless'){console.assert(!G.cfg.boss,'Endless boss flag should be false')}const x0=G.p.xp;G.gm.push({x:G.p.x,y:G.p.y,r:6,v:Math.ceil(1*G.cfg.xpm),vx:0,vy:0,c:false});const pk=G.p.pick;G.p.pick=9999;upd(.016);G.p.pick=pk;console.assert(G.p.xp>x0,'XP not increased');const sh=new E(G.p.x-100,G.p.y-100,3);sh.rate=G.cfg.sr;sh.cd=0;const b0=G.eb.length;sh.u(.1);console.assert(G.eb.length>b0,'Shooter emit fail');const last=G.eb[G.eb.length-1];console.assert(typeof last.vx==='number'&&typeof last.vy==='number','enemy bullet vx/vy numeric');G.en=[new E(G.p.x+300,G.p.y,0),new E(G.p.x+50,G.p.y,0)];G.boss=new B;G.boss.x=G.p.x+40;G.boss.y=G.p.y;function AC(px,py){let best=null,bd=1/0;for(const e of G.en){if(e.dead)continue;const dd=ds(px,py,e.x,e.y);if(dd<bd){bd=dd;best=e}}if(G.boss){const db=ds(px,py,G.boss.x,G.boss.y);if(db<bd){best=G.boss;bd=db}}return best}console.assert(AC(G.p.x,G.p.y)===G.boss,'Nearest should be boss');G.en=[new E(G.p.x+60,G.p.y,0),new E(G.p.x-60,G.p.y,0)];G.en[0].hp=4;G.en[1].hp=1;G.boss=null;const tg2=tgt(G.p.x,G.p.y);console.assert(tg2===G.en[1],'Tiebreak lower HP when equidistant');if(HELP){showM();console.assert(HELP.style.display==='none','Help hide on menu');hideM();console.assert(HELP.style.display==='block','Help show after menu')}
// Visible-only target selection
const cv=$("game"),vw=cv.clientWidth,vh=cv.clientHeight;reset(DEF.classic);G.cam.x=G.p.x;G.cam.y=G.p.y;const eIn=new E(G.p.x+vw/2-50,G.p.y,0);const eOut=new E(G.p.x+vw/2+200,G.p.y,0);G.en=[eIn,eOut];const sel=tgt(G.p.x,G.p.y);console.assert(sel===eIn,'Visible enemy should be selected over off-screen');
// Joystick moves player
const xBefore=G.p.x;JOY.active=true;JOY.dx=1;JOY.dy=0;upd(.016);JOY.active=false;console.assert(G.p.x>xBefore,'Player should move right with virtual joystick');
// Railgun test
reset(DEF.classic);G.cam.x=G.p.x;G.cam.y=G.p.y;G.p.rail.lv=1;G.p.rail.last=G.p.rail.int;const e1=new E(G.p.x+120,G.p.y,0);const e2=new E(G.p.x+260,G.p.y,0);G.en=[e1,e2];upd(.016);console.assert(e1.hp<4 && e2.hp<4,'Railgun should damage enemies in line');
// Shield reflect test
reset(DEF.classic);G.p.shield.lv=1;G.p.shield.dx=1;G.p.shield.dy=0;G.cam.x=G.p.x;G.cam.y=G.p.y;G.eb=[{x:G.p.x+30,y:G.p.y,r:5,vx:-120,vy:0,dm:1,life:1}];const pr0=G.pr.length;upd(.016);console.assert(G.pr.length>pr0,'Shield should convert bullet to PR');
// Gravity well spawn test
reset(DEF.classic);G.cam.x=G.p.x;G.cam.y=G.p.y;G.p.well.lv=1;G.p.well.last=G.p.well.int;G.en=[new E(G.p.x+200,G.p.y,0),new E(G.p.x+220,G.p.y+10,0)];upd(.016);console.assert(G.wl.length>0,'Gravity well should spawn');
// Turret spawn & shoot
reset(DEF.classic);G.p.tur.lv=1;G.p.tur.mx=2;G.p.tur.last=G.p.tur.int;G.en=[new E(G.p.x+140,G.p.y,0)];upd(.2);const trc=G.tr.length;console.assert(trc>0,'Turret should deploy');const prc0=G.pr.length;upd(1.0);console.assert(G.pr.length>prc0,'Turret should fire');
// Mine spawn while moving
reset(DEF.classic);G.p.mine.lv=1;JOY.active=true;JOY.dx=1;JOY.dy=0;let mn0=G.mn.length;upd(.5);JOY.active=false;console.assert(G.mn.length>mn0,'Mine should drop while moving');
// Void blade damages
reset(DEF.classic);G.cam.x=G.p.x;G.cam.y=G.p.y;G.p.vb.lv=1;G.p.vb.last=G.p.vb.int;const e3=new E(G.p.x+100,G.p.y,0);G.en=[e3];upd(.016);const hpBefore=e3.hp;upd(.5);console.assert(e3.hp<hpBefore,'Void blade should deal DoT');
// Reroll API
reset(DEF.classic);Q();const before=CHO.innerHTML;doReroll();const after=CHO.innerHTML;console.assert(before!==after,'Reroll should rebuild choices');const after2=CHO.innerHTML;doReroll();const after3=CHO.innerHTML;console.assert(after2===after3,'Second reroll should have no effect');hideLU();
// Piercing projectile hits two enemies
reset(DEF.classic);const ea=new E(G.p.x+20,G.p.y,0), eb=new E(G.p.x+24,G.p.y,0);G.en=[ea,eb];const pr=new PR(G.p.x,G.p.y,1,0);pr.dm=1;pr.pi=1;G.pr=[pr];upd(.016);console.assert(ea.hp<4 && eb.hp<4,'Piercing PR should damage two enemies');
// Mine slow field applies
reset(DEF.classic);G.p.mine.lv=1;G.p.mine.slow=true;const es=new E(G.p.x+10,G.p.y,0);G.en=[es];G.mn=[{x:es.x,y:es.y,arm:0,tr:0.2,boom:false}];upd(.021);console.assert(es.slowt>0,'Mine slow field should apply');
// Void blade extra spawns when upgraded
reset(DEF.classic);G.p.vb.lv=1;G.p.vb.extra=1;G.p.vb.last=G.p.vb.int;G.shx=1;G.shy=0;upd(.016);console.assert(G.vb.length===2,'Extra void blade should spawn when upgraded');
// Void blade aims nearest enemy (not movement)
reset(DEF.classic); G.cam.x=G.p.x; G.cam.y=G.p.y; G.p.vb.lv=1; G.p.vb.last=G.p.vb.int; const eL=new E(G.p.x-100,G.p.y,0); const eR=new E(G.p.x+200,G.p.y,0); G.en=[eL,eR]; G.shx=0; G.shy=0; upd(.016); console.assert(G.vb.length>0 && G.vb[0].vx<0,'Void blade should aim at nearest (left) enemy when idle');
// Void blade width upgrade increases hitbox
reset(DEF.classic); G.cam.x=G.p.x; G.cam.y=G.p.y; G.p.vb.lv=1; G.p.vb.rad=6; G.p.vb.last=G.p.vb.int; G.shx=1; G.shy=0; const eOff1=new E(G.p.x+120,G.p.y+14,0); eOff1.s=0; G.en=[eOff1]; upd(.016); const hpOffBefore=eOff1.hp; upd(.25); console.assert(eOff1.hp===hpOffBefore,'Narrow blade should miss slightly offset enemy');
reset(DEF.classic); G.cam.x=G.p.x; G.cam.y=G.p.y; G.p.vb.lv=1; G.p.vb.rad=6; const upW=UPS.find(u=>u.k==='vb_w'); upW&&upW.ap(); upW&&upW.ap(); // widen twice
G.p.vb.last=G.p.vb.int; G.shx=1; G.shy=0; const eOff2=new E(G.p.x+120,G.p.y+14,0); eOff2.s=0; G.en=[eOff2]; upd(.016); const hpOffBefore2=eOff2.hp; upd(.25); console.assert(eOff2.hp<hpOffBefore2,'Wider blade should hit slightly offset enemy');
// New tests: GO pauses game and hides skip/reroll; and void blade length affects reach
reset(DEF.classic); GO(false);
console.assert(G.paused===true,'GO should pause the game');
console.assert(REROLL.style.display==='none' && SKIP.style.display==='none','Skip/Reroll hidden on game over');
reset(DEF.classic); G.cam.x=G.p.x; G.cam.y=G.p.y; G.p.vb.lv=1; G.p.vb.len=60; G.p.vb.last=G.p.vb.int; G.shx=1; G.shy=0; const evb1=new E(G.p.x+120,G.p.y,0); evb1.s=0; G.en=[evb1]; upd(.016); const hpvb1=evb1.hp; upd(.2); console.assert(evb1.hp===hpvb1,'Short blade should not reach distant enemy');
reset(DEF.classic); G.cam.x=G.p.x; G.cam.y=G.p.y; G.p.vb.lv=1; G.p.vb.len=240; G.p.vb.last=G.p.vb.int; G.shx=1; G.shy=0; const evb2=new E(G.p.x+200,G.p.y,0); evb2.s=0; G.en=[evb2]; upd(.016); const hpvb2=evb2.hp; upd(.2); console.assert(evb2.hp<hpvb2,'Long blade should reach farther enemy');
showM();reset(DEF.classic);console.assert(MENU.style.display==='grid','Restart should open menu');const pre=spInt();const tmp=G.boss;G.boss=new B;const slower=spInt();console.assert(slower>pre,'Boss waves must be slower');G.boss=tmp;console.assert(Math.abs(hpMul(5)-1.25)<1e-6,'HP scale cap 1.25');Object.assign(G,{stage:sv.st,boss:sv.b,bs:sv.bs,en:sv.en,eb:sv.eb,time:sv.t,minute:sv.m});G.p.xp=sv.x;G.p.pick=sv.p;G.last=sv.last;G.cfg=sv.cfg}catch(e){console.error('[TEST] failed',e)}}
R();reset(DEF.classic);showM();requestAnimationFrame(loop)})();</script></body></html>
