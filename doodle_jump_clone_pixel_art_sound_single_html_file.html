<!doctype html>
<html lang="ko">
  
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ë‘ë“¤ ì í”„ í´ë¡  Â· Pixel + SFX</title>
<style>
  :root { color-scheme: dark; }
  html, body { height: 100%; margin: 0; background: radial-gradient(120% 120% at 50% 20%, #0f172a 0%, #0b1022 45%, #050814 100%); font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; color:#e5e7eb }
  #wrap { position: fixed; inset: 0; display: grid; place-items: center; }
  canvas { image-rendering: pixelated; image-rendering: crisp-edges; box-shadow: 0 10px 40px rgba(0,0,0,.5); border-radius: 14px; background:#0b1224; }
  .hud { position: fixed; inset: 0; pointer-events: none; }
  .top { position: absolute; left: 10px; right: 10px; top: 10px; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
  .chip { background: rgba(255,255,255,.06); padding: 6px 10px; border-radius: 10px; backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.08); font-weight:600; font-size: 12px }
  .btn { pointer-events: all; cursor: pointer; user-select: none; }
  .center { position: absolute; inset: 0; display: grid; place-items: center; text-align: center; }
  .card { background: rgba(4,6,20,.7); padding: 14px 16px; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; max-width: 90vw; }
  .card h1 { margin: 0 0 10px; font-size: 16px; }
  .kbd { display:inline-block; padding:1px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); font-weight:700; font-size:12px }
  .hide { display:none }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="160" height="240"></canvas>
  <div class="hud">
    <div class="top">
      <div class="chip">ì ìˆ˜ <span id="score">0</span> Â· ìµœê³  <span id="hi">0</span></div>
      <div class="chip btn" id="muteBtn" title="M í‚¤ë¡œë„ ì „í™˜">ğŸ”Š ì†Œë¦¬ ì¼œì§</div>
    </div>
    <div id="start" class="center">
      <div class="card">
        <h1>ë‘ë“¤ ì í”„ (ë„íŠ¸ + ì‚¬ìš´ë“œ)</h1>
        <div style="opacity:.9">â† â†’ ë˜ëŠ” <span class="kbd">A</span>/<span class="kbd">D</span> ì´ë™ Â· <span class="kbd">M</span> ìŒì†Œê±° Â· ëª¨ë°”ì¼ì€ ì¢Œ/ìš° í™”ë©´ í„°ì¹˜</div>
        <div style="opacity:.7;margin-top:8px">ì‹œì‘í•˜ë ¤ë©´ í´ë¦­/íƒ­ ë˜ëŠ” í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”</div>
      </div>
    </div>
    <div id="gameover" class="center hide">
      <div class="card">
        <h1>ê²Œì„ ì˜¤ë²„</h1>
        <div style="margin:.2rem 0 .6rem">ì ìˆ˜ <span id="final">0</span></div>
        <div class="chip btn" id="restartBtn">ë‹¤ì‹œ ì‹œì‘ (R)</div>
      </div>
    </div>
  </div>
</div>
<script>
(() => {
  // ===== ê¸°ë³¸ ì„¤ì • =====
  const W = 160, H = 240; // ë‚´ë¶€ í•´ìƒë„ (ë„íŠ¸ ëŠë‚Œ ìœ ì§€)
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  // í™”ë©´ í¬ê¸°ì— ë§ì¶° í™•ëŒ€ (ì •ìˆ˜ ë°°ìœ¨ ìš°ì„ )
  function fit() {
    const vw = window.innerWidth, vh = window.innerHeight;
    const scale = Math.floor(Math.min(vw / W, vh / H));
    const cssW = Math.max(W * Math.max(1, scale), Math.min(vw, W*3));
    const cssH = cssW * (H / W);
    canvas.style.width = cssW + 'px';
    canvas.style.height = cssH + 'px';
  }
  window.addEventListener('resize', fit); fit();

  // ===== UI ì—˜ë¦¬ë¨¼íŠ¸ =====
  const elScore = document.getElementById('score');
  const elHi = document.getElementById('hi');
  const startCard = document.getElementById('start');
  const overCard = document.getElementById('gameover');
  const elFinal = document.getElementById('final');
  const muteBtn = document.getElementById('muteBtn');
  const restartBtn = document.getElementById('restartBtn');

  // ===== ì‚¬ìš´ë“œ (WebAudio, ì™¸ë¶€ íŒŒì¼ ì—†ìŒ) =====
  let AC = null; // AudioContext (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ ìƒì„±)
  let muted = false;
  function initAudio() {
    if (!AC) {
      const Ctx = window.AudioContext || window.webkitAudioContext;
      AC = new Ctx();
    }
    if (AC.state === 'suspended') AC.resume();
  }
  function sfx({type='square', freq=440, dur=0.08, vol=0.2, sweep=0}) {
    if (muted) return;
    if (!AC) return; // ì•„ì§ ì‹œì‘ ì „
    const t0 = AC.currentTime;
    const osc = AC.createOscillator();
    const gain = AC.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    if (sweep !== 0) {
      osc.frequency.setValueAtTime(freq, t0);
      osc.frequency.exponentialRampToValueAtTime(Math.max(40, freq * Math.pow(2, sweep)), t0 + dur);
    }
    gain.gain.setValueAtTime(vol, t0);
    gain.gain.exponentialRampToValueAtTime(0.001, t0 + dur);
    osc.connect(gain).connect(AC.destination);
    osc.start();
    osc.stop(t0 + dur + 0.02);
  }
  function blipJump(){ sfx({type:'square', freq:520, dur:0.06, vol:0.25}); }
  function blipSpring(){ sfx({type:'sawtooth', freq:700, dur:0.18, vol:0.22, sweep:-0.7}); }
  function blipBreak(){ sfx({type:'triangle', freq:120, dur:0.12, vol:0.2, sweep:-0.3}); }
  function blipLose(){ sfx({type:'square', freq:200, dur:0.3, vol:0.25, sweep:-1}); }

  muteBtn.addEventListener('click', () => { muted = !muted; muteBtn.textContent = (muted? 'ğŸ”‡ ì†Œë¦¬ êº¼ì§' : 'ğŸ”Š ì†Œë¦¬ ì¼œì§'); initAudio(); });

  // ===== ê²Œì„ ìƒíƒœ =====
  const rnd = (a,b)=> a + Math.random()*(b-a);
  const irnd = (a,b)=> Math.floor(rnd(a,b+1));
  const clamp = (v,a,b)=> Math.max(a, Math.min(b,v));
  // í•œ ë²ˆì˜ ì í”„ë¡œ ì•ˆì „í•˜ê²Œ ì´ë™ ê°€ëŠ¥í•œ ìˆ˜í‰ ê±°ë¦¬(ë³´ìˆ˜ì )
  const MAX_HOP_DX = 36;

  let hi = Number(localStorage.getItem('dj_hi')||0);
  elHi.textContent = hi;

  const State = {
    READY: 0, RUN: 1, OVER: 2
  }
  let state = State.READY;

  // í”Œë ˆì´ì–´(ë„íŠ¸)
  const P = {
    x: W/2, y: H-40,
    w: 12, h: 12,
    vx: 0, vy: -380,
  };

  // ì…ë ¥
  const input = { left:false, right:false };
  function setKey(e, down){
    const k = e.key.toLowerCase();
    if (k==='arrowleft' || k==='a') input.left = down;
    if (k==='arrowright' || k==='d') input.right = down;
    if (k==='m' && down) { muted=!muted; muteBtn.textContent = (muted? 'ğŸ”‡ ì†Œë¦¬ êº¼ì§' : 'ğŸ”Š ì†Œë¦¬ ì¼œì§'); initAudio(); }
    if (k==='r' && down && state===State.OVER) restart();
  }
  window.addEventListener('keydown', e=>{ initAudio(); setKey(e,true); if (state===State.READY) start(); });
  window.addEventListener('keyup', e=> setKey(e,false));

  // í„°ì¹˜/ë§ˆìš°ìŠ¤: ì¢Œ/ìš° ì˜ì—­ í„°ì¹˜ë¡œ ì´ë™
  canvas.addEventListener('pointerdown', (e) => { initAudio(); if (state===State.READY) start(); handlePointer(e, true); });
  canvas.addEventListener('pointermove', (e) => handlePointer(e, true));
  window.addEventListener('pointerup', () => { input.left = input.right = false; });
  function handlePointer(e, active){
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    input.left = input.right = false;
    if (!active) return;
    if (x < rect.width/2) input.left = true; else input.right = true;
  }

  // í”Œë«í¼
  const plats = [];
  let spawnY = H - 20; // ë‹¤ìŒ ìƒì„±ë  y ê¸°ì¤€ (ì•„ë˜ì—ì„œ ìœ„ë¡œ ì±„ì›€)
  let score = 0;

  function makePlat(y){
    const prev = plats.length ? plats[plats.length - 1] : null;

    // ê°„ê²©: ë„ˆë¬´ ë²Œì–´ì§€ì§€ ì•Šë„ë¡ ìƒí•œì„ ë‚®ì¶¤
    const baseGap = 26 + ((score/120)|0);
    const gap = clamp(baseGap, 24, 32);

    const w = irnd(28, 40);

    // íƒ€ì… í™•ë¥ 
    const moveP   = clamp(0.10 + score/3000, .10, .18);
    const breakP  = clamp(0.06 + score/4000, .06, .12);
    const springP = clamp(0.12 + score/2000, .12, .18);

    const r = Math.random();
    let type = 'normal';
    let dx = 0, broken = false, hasSpring = false;

    if (r < moveP)              { type='move';    dx = Math.random()<.5 ? -0.25 : 0.25; }
    else if (r < moveP+breakP)  { type='fragile'; broken = false; }
    if (Math.random() < springP){ hasSpring = true; }

    // ì´ì „ ë°œíŒ ì¤‘ì‹¬ ê¸°ì¤€, ìˆ˜í‰ ë„ë‹¬ ê°€ëŠ¥ ë²”ìœ„ ì•ˆì—ì„œ x ì„ íƒ
    const xMin = 4, xMax = W - w - 4;
    let x;
    if (prev){
      const prevC = prev.x + prev.w/2;
      const reach = hasSpring ? Math.floor(MAX_HOP_DX * 1.4) : MAX_HOP_DX;
      const candMin = prevC - reach - (w/2);
      const candMax = prevC + reach - (w/2);
      x = clamp(irnd(candMin, candMax), xMin, xMax);
    } else {
      x = irnd(xMin, xMax);
    }

    plats.push({ x, y, w, h:6, type, dx, broken, hasSpring });
    spawnY -= gap;
  }

  function seedPlats(){
    plats.length = 0; spawnY = H-16;
    // ë°”ë‹¥ ê·¼ì²˜ ì´˜ì´˜íˆ
    for(let y = H-18; y > -H*2; ){
      makePlat(y);
      y = spawnY;
    }
    // ì•ˆì „ ì‹œì‘ í”Œë«í¼ ë³´ì •
    const startP = plats.reduce((best,p)=> p.y>best.y? p:best, plats[0]);
    startP.x = clamp(P.x - startP.w/2, 4, W-startP.w-4);
    startP.type='normal'; startP.hasSpring=false; startP.broken=false; startP.dx=0;
  }

  // ì¶©ëŒ ì²´í¬ (í•˜ê°• ì¤‘, ë°œ ìœ„ì— ì°©ì§€)
  function collidePlat(p){
    if (P.vy <= 0) return false; // ìœ„ë¡œ ì´ë™ ì¤‘ì—” ë¬´ì‹œ
    const px1=P.x, px2=P.x+P.w, py2=P.y+P.h; // í”Œë ˆì´ì–´ ë°”ë‹¥
    const qx1=p.x, qx2=p.x+p.w, qy1=p.y;     // í”Œë«í¼ ìœ—ë©´
    if (py2 <= qy1 && py2 + P.vy*dt >= qy1 && px2 > qx1 && px1 < qx2){
      // ìŠ¤í”„ë§ ë¨¼ì € ì²´í¬
      if (p.hasSpring){
        const sx1 = p.x + p.w/2 - 4, sx2=sx1+8, sy=p.y-4;
        if (px2 > sx1 && px1 < sx2){
          P.vy = -JUMP*1.6; blipSpring(); return true;
        }
      }
      if (p.type==='fragile') { p.broken=true; blipBreak(); return false; }
      P.vy = -JUMP; blipJump(); return true;
    }
    return false;
  }

  // ê·¸ë¦¬ê¸°: ë„íŠ¸ ìŠ¤íƒ€ì¼ í”½ì…€ ë“œë¡œì‰
  function px(x,y,w,h,color){ ctx.fillStyle=color; ctx.fillRect(x|0,y|0,w|0,h|0); }
  function drawBackground(){
    // ë³„/ë²„ë¸” ê°™ì€ ë‹¨ìˆœ ë°°ê²½ (íŒ¨ëŸ´ë™ìŠ¤ ëŠë‚Œ)
    ctx.clearRect(0,0,W,H);
    for (let i=0;i<24;i++) px((i*37+tick/8)%W, (i*53 - tick/5)%H, 1,1, '#1e2a54');
    for (let i=0;i<16;i++) px((i*53 - tick/6 + 40)%W, (i*71 + tick/7 + 20)%H, 1,1, '#16224a');
  }
  function drawPlayer(){
    const x=P.x|0, y=P.y|0;
    // ë³¸ì²´
    px(x+2,y+2,8,8,'#f5f5f5'); // ëª¸í†µ
    // í…Œë‘ë¦¬
    px(x+1,y+1,10,1,'#0a0a0a'); px(x+1,y+9,10,1,'#0a0a0a');
    px(x+1,y+2,1,7,'#0a0a0a'); px(x+10,y+2,1,7,'#0a0a0a');
    // ëˆˆ
    px(x+4,y+5,1,1,'#0a0a0a'); px(x+7,y+5,1,1,'#0a0a0a');
    // ë°œ
    px(x+2,y+10,3,2,'#96f'); px(x+7,y+10,3,2,'#96f');
  }
  function drawPlat(p){
    if (p.type==='fragile' && p.broken){
      // ê¹¨ì§ ì”í•´
      px(p.x, p.y+2, p.w, 1, '#3a2d16');
      px(p.x+2, p.y+4, p.w-4, 1, '#241b0e');
      return;
    }
    const col = p.type==='move' ? '#5dd3ff' : (p.type==='fragile' ? '#c7a66a' : '#74f37a');
    // ë³¸ì²´
    px(p.x, p.y, p.w, p.h, col);
    // ê°€ì¥ìë¦¬ ê·¸ë¦¼ì
    px(p.x, p.y+p.h-1, p.w, 1, '#0a0a0a');
    // ìŠ¤í”„ë§
    if (p.hasSpring){
      const sx = p.x + (p.w>>1) - 3, sy = p.y - 5;
      px(sx, sy, 6, 2, '#ddd');
      px(sx, sy+2, 6, 1, '#bbb');
      px(sx+1, sy+3, 4, 1, '#999');
    }
  }

  // ë¬¼ë¦¬/ì¹´ë©”ë¼
  const JUMP = 360; // ê¸°ë³¸ ì í”„ ì†ë„
  const GRAV = 980; // ì¤‘ë ¥ (px/s^2)
  let dt = 1/60, acc=0, last=0, tick=0;

  function start(){
    state = State.RUN; startCard.classList.add('hide'); overCard.classList.add('hide');
    initAudio(); restart();
  }
  function restart(){
    score = 0; elScore.textContent = '0';
    P.x=W/2-6; P.y=H-40; P.vx=0; P.vy=-JUMP;
    seedPlats();
    state = State.RUN; overCard.classList.add('hide');
  }

  function update(dt){
    tick += dt*60;
    // ì…ë ¥ -> ì†ë„
    const speed = 80; // ì¢Œìš° ì´ë™ ì†ë„ (px/s)
    P.vx = (input.right - input.left) * speed;
    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    P.vy += GRAV * dt;
    P.x += P.vx * dt;
    P.y += P.vy * dt;
    // ì¢Œìš° ë˜í•‘
    if (P.x < -P.w) P.x = W;
    if (P.x > W) P.x = -P.w;

    // ì´ë™ í”Œë«í¼
    for (const p of plats){
      if (p.type==='move'){
        p.x += p.dx * 60 * dt; // í”„ë ˆì„ ë³´ì •
        if (p.x < 2 || p.x + p.w > W-2) p.dx *= -1;
      }
    }

    // ì¶©ëŒ (ì°©ì§€)
    for (const p of plats) collidePlat(p);

    // ì¹´ë©”ë¼: í”Œë ˆì´ì–´ê°€ í™”ë©´ ìƒë‹¨ 40% ë„˜ìœ¼ë©´ ëª¨ë“  ê²ƒì„ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
    if (P.y < H*0.4){
      const dy = H*0.4 - P.y;
      P.y += dy; // í™”ë©´ ë‚´ ê³ ì •
      for (const p of plats) p.y += dy;
      spawnY += dy; // âœ… ì¹´ë©”ë¼ ìŠ¤í¬ë¡¤ ì‹œ ë‹¤ìŒ ìƒì„± Yë„ ê°™ì´ ì´ë™ (í° ê°„ê²© ë²„ê·¸ ìˆ˜ì •)
      score += dy|0; elScore.textContent = score|0;
    }

    // ë°”ë‹¥ìœ¼ë¡œ ë–¨ì–´ì§€ë©´ ê²Œì„ì˜¤ë²„
    if (P.y > H + 20){
      state = State.OVER; blipLose();
      elFinal.textContent = score|0; overCard.classList.remove('hide');
      if (score > hi){ hi = score|0; localStorage.setItem('dj_hi', hi); elHi.textContent = hi; }
    }

    // í”Œë«í¼ ì¬ìƒì„±: ì•„ë˜ë¡œ ì‚¬ë¼ì§„ ê±´ ì œê±°, ìœ„ë¡œ ìƒˆë¡œ ìƒì„±
    for (let i=plats.length-1; i>=0; i--){
      if (plats[i].y > H + 12) plats.splice(i,1);
    }
    while (plats.length < 26){
      makePlat(spawnY);
    }
  }

  function render(){
    drawBackground();
    for (const p of plats) drawPlat(p);
    drawPlayer();
  }

  function loop(t){
    if (!last) last = t; let delta = (t - last)/1000; last = t; delta = Math.min(delta, 0.05);
    acc += delta; const step = 1/60;
    if (state === State.RUN) {
      while (acc >= step){ update(step); acc -= step; }
    } else {
      acc = 0; // ì •ì§€ ìƒíƒœì—ì„œ ì ì‚° ë°©ì§€
    }
    render();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ì²˜ìŒ í´ë¦­/í‚¤ ì…ë ¥ìœ¼ë¡œ ì‹œì‘
  startCard.addEventListener('click', ()=>{ initAudio(); start(); });
  restartBtn.addEventListener('click', ()=> restart());
})();
</script>
</body>
</html>
